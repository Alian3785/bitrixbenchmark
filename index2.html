<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Битва при Кадеше — визуализация в стиле Древнего Египта</title>
  <style>
    :root{
      /* Egyptian palette */
      --papyrus:#f3e6c8;
      --papyrus2:#ead8ae;
      --ink:#2b1e15;
      --ink2:#4b3727;
      --gold:#d4af37;
      --lapis:#1e3a8a;
      --malachite:#0f766e;
      --ochre:#9b2c1a;

      --border: rgba(43,30,21,.22);
      --border2: rgba(43,30,21,.14);
      --shadow: 0 16px 44px rgba(43,30,21,.18);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color: var(--ink);
      font-family: ui-serif, Georgia, "Times New Roman", Times, serif;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(212,175,55,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(30,58,138,.12), transparent 60%),
        linear-gradient(180deg, var(--papyrus), var(--papyrus2));
      overflow-x:hidden;
    }

    /* papyrus grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
        repeating-linear-gradient(25deg, rgba(43,30,21,.04) 0 2px, transparent 2px 10px),
        repeating-linear-gradient(-18deg, rgba(43,30,21,.025) 0 1px, transparent 1px 9px);
      opacity:.22;
      mix-blend-mode:multiply;
    }

    .wrap{max-width:1120px;margin:0 auto;padding:26px 18px 70px}

    .topfrieze{
      height:10px;
      border-radius:999px;
      background:
        repeating-linear-gradient(90deg,
          rgba(212,175,55,.9) 0 18px,
          rgba(30,58,138,.75) 18px 28px,
          rgba(15,118,110,.75) 28px 38px,
          rgba(155,44,26,.75) 38px 48px
        );
      box-shadow: 0 10px 24px rgba(43,30,21,.12);
      margin-bottom:16px;
      border:1px solid rgba(43,30,21,.18);
    }

    header{
      display:flex;gap:18px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
    }

    .hero{
      flex: 1 1 620px;
      padding:20px 22px 18px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:
        radial-gradient(700px 260px at 70% 0%, rgba(212,175,55,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }

    .hero:after{
      content:"";
      position:absolute; inset:10px;
      border-radius: calc(var(--radius) - 8px);
      border: 2px solid rgba(212,175,55,.35);
      pointer-events:none;
    }

    .kicker{
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(43,30,21,.72);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    h1{
      margin:10px 0 6px;
      font-size: clamp(30px, 4vw, 46px);
      line-height:1.06;
      letter-spacing:.02em;
    }

    .orn{
      margin:0 0 10px;
      color: rgba(43,30,21,.70);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size:13px;
      letter-spacing:.12em;
    }

    .sub{
      color: rgba(43,30,21,.80);
      font-size:15px;
      line-height:1.55;
      max-width:75ch;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .pillrow{display:flex; gap:8px; flex-wrap:wrap; margin-top:14px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.35);
      color: rgba(43,30,21,.82);
      font-size:13px;
      backdrop-filter: blur(6px);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .dot{width:10px;height:10px;border-radius:50%}

    .side{
      flex: 1 1 320px;
      display:flex; flex-direction:column; gap:12px;
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.52), rgba(255,255,255,.26));
      box-shadow: var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute; left:0; right:0; top:0;
      height:8px;
      background:
        repeating-linear-gradient(90deg,
          rgba(212,175,55,.85) 0 22px,
          rgba(30,58,138,.68) 22px 34px,
          rgba(15,118,110,.68) 34px 46px,
          rgba(155,44,26,.68) 46px 58px
        );
      opacity:.7;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:6px}

    button{
      appearance:none;
      border:1px solid rgba(43,30,21,.28);
      background:
        linear-gradient(180deg, rgba(212,175,55,.38), rgba(255,255,255,.18));
      color: var(--ink);
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .12s ease, filter .2s ease, background .2s ease;
      font-weight:800;
      letter-spacing:.02em;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 10px 22px rgba(43,30,21,.12);
    }
    button:hover{transform: translateY(-1px); filter: brightness(1.03)}
    button:active{transform: translateY(0px) scale(.98)}
    button.primary{
      background: linear-gradient(180deg, rgba(30,58,138,.18), rgba(212,175,55,.32));
    }
    button.danger{
      background: linear-gradient(180deg, rgba(155,44,26,.18), rgba(255,255,255,.16));
    }
    button:disabled{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none}

    .small{
      font-size:12px;
      color: rgba(43,30,21,.70);
      line-height:1.45;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    main{margin-top:18px; display:grid; grid-template-columns: 1.55fr .45fr; gap:14px}
    @media (max-width: 980px){ main{grid-template-columns:1fr} }

    .viz{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.50), rgba(255,255,255,.20));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .vizHead{
      padding:14px 14px 10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid rgba(43,30,21,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,0));
    }

    .phaseTitle{
      font-size:16px;
      font-weight:900;
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.01em;
    }
    .phaseText{
      color: rgba(43,30,21,.78);
      font-size:13px;
      margin-top:4px;
      max-width:75ch;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .toggleRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size:12px;
      color: rgba(43,30,21,.70);
      margin-top:8px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .legendItem{display:flex; align-items:center; gap:8px}
    .swatch{width:12px;height:12px;border-radius:4px;border:1px solid rgba(43,30,21,.2)}

    .mapWrap{padding:12px}

    .timeline{
      position:absolute; left:0; right:0; bottom:0;
      padding:12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(243,230,200,.95));
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      border-top:1px solid rgba(43,30,21,.14);
    }

    .dots{display:flex; gap:10px; align-items:center}
    .tdot{
      width:14px;height:14px;border-radius:999px;
      border:1px solid rgba(43,30,21,.35);
      background:rgba(255,255,255,.35);
      cursor:pointer;
      position:relative;
    }
    .tdot.active{background: rgba(212,175,55,.55); border-color: rgba(43,30,21,.45)}
    .tdot:hover{transform: translateY(-1px)}
    .hint{
      font-size:12px;
      color: rgba(43,30,21,.70);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* SVG */
    svg{width:100%; height:auto; display:block; border-radius: 14px;}
    .terrain{ filter: drop-shadow(0 18px 28px rgba(43,30,21,.18)); }

    .unit{
      --x:0px; --y:0px;
      transform: translate(var(--x), var(--y));
      transition: transform 1100ms cubic-bezier(.2,.9,.2,1);
    }
    .unit rect.base{
      rx:12; ry:12;
      stroke: rgba(43,30,21,.28);
      stroke-width:1.2;
    }

    .unit text{
      font-weight:900;
      font-size:14px;
      fill: rgba(43,30,21,.92);
      paint-order: stroke;
      stroke: rgba(243,230,200,.7);
      stroke-width:2.5px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.01em;
    }

    .tag, .count{
      font-weight:800;
      font-size:12px;
      fill: rgba(43,30,21,.82);
      opacity:.95;
      stroke: rgba(243,230,200,.65);
      stroke-width:2px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* pattern overlay inside unit */
    .patFill{
      opacity:.30;
      pointer-events:none;
      mix-blend-mode:multiply;
    }

    /* side colors */
    .egy rect.base{fill: rgba(212,175,55,.28)}     /* gold */
    .hit rect.base{fill: rgba(30,58,138,.18)}      /* lapis */
    .camp rect.base{fill: rgba(15,118,110,.16)}    /* malachite */

    /* arrows */
    .arrow{
      fill:none;
      stroke-width:4.5;
      stroke-linecap:round;
      stroke-linejoin:round;
      opacity:0;
      transition: opacity 350ms ease;
      filter: drop-shadow(0 8px 12px rgba(43,30,21,.16));
    }
    .arrow.on{opacity:1}
    .arrow.egy{stroke: rgba(212,175,55,.92)}
    .arrow.hit{stroke: rgba(30,58,138,.88)}
    .arrow.bad{stroke: rgba(155,44,26,.88)}

    .poi{
      font-size:13px;
      fill: rgba(43,30,21,.90);
      font-weight:900;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.06em;
    }
    .poiSmall{
      font-size:12px;
      fill: rgba(43,30,21,.68);
      font-weight:800;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* sidebar */
    .sidebar{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.52), rgba(255,255,255,.22));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }

    .tabs{
      display:flex; gap:8px; padding:12px;
      border-bottom:1px solid rgba(43,30,21,.14);
      flex-wrap:wrap;
      background: rgba(255,255,255,.25);
    }
    .tab{
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(43,30,21,.20);
      background: rgba(255,255,255,.25);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      color: rgba(43,30,21,.86);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .tab.active{
      background: linear-gradient(180deg, rgba(212,175,55,.35), rgba(255,255,255,.18));
      border-color: rgba(43,30,21,.28);
    }

    .pane{padding:12px; display:none}
    .pane.active{display:block}

    .fact{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px;
      border-radius: 14px;
      background: rgba(255,255,255,.25);
      border:1px solid rgba(43,30,21,.14);
      margin-bottom:10px;
      box-shadow: 0 10px 22px rgba(43,30,21,.08);
    }
    .fact b{
      display:block;
      font-size:13px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      letter-spacing:.01em;
    }
    .fact p{
      margin:3px 0 0;
      color: rgba(43,30,21,.74);
      font-size:12px;
      line-height:1.45;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .grid2{display:grid; grid-template-columns:1fr; gap:10px}
    .wcard{
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(43,30,21,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.18));
      cursor:pointer;
      transition: transform .12s ease, filter .2s ease;
      box-shadow: 0 10px 22px rgba(43,30,21,.10);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wcard:hover{transform: translateY(-1px); filter: brightness(1.02)}
    .whead{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .whead h3{margin:0; font-size:13px; letter-spacing:.01em}
    .whead .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(43,30,21,.18);
      background: rgba(212,175,55,.22);
      color: rgba(43,30,21,.86);
      font-weight:800;
    }
    .wbody{margin-top:8px}
    .wbody p{margin:0; color: rgba(43,30,21,.74); font-size:12px; line-height:1.45}

    /* modal */
    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(43,30,21,.35);
      padding: 18px;
      z-index:50;
    }
    .modal.on{display:flex}
    .modalCard{
      max-width: 820px;
      width: 100%;
      border-radius: 20px;
      border:1px solid rgba(43,30,21,.22);
      background: linear-gradient(180deg, rgba(255,255,255,.86), rgba(243,230,200,.92));
      box-shadow: 0 30px 90px rgba(43,30,21,.28);
      overflow:hidden;
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .modalTop{
      display:flex; justify-content:space-between; gap:12px; align-items:center;
      padding:14px 16px;
      border-bottom:1px solid rgba(43,30,21,.14);
      background:
        linear-gradient(180deg, rgba(212,175,55,.22), rgba(255,255,255,.18));
    }
    .modalTop h2{margin:0; font-size:16px}
    .modalTop .x{
      border-radius: 12px;
      padding:9px 10px;
      background: rgba(255,255,255,.35);
      border:1px solid rgba(43,30,21,.22);
      box-shadow:none;
    }
    .modalBody{padding:14px 16px}
    .modalBody p{margin:8px 0; color: rgba(43,30,21,.84); line-height:1.55}
    .cols{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px}
    @media (max-width: 820px){ .cols{grid-template-columns:1fr} }
    .mini{
      border:1px solid rgba(43,30,21,.14);
      border-radius: 18px;
      background: rgba(255,255,255,.28);
      padding: 12px;
    }
    .mini h4{margin:0 0 6px; font-size:13px}
    .mini ul{margin:0; padding-left:18px; color: rgba(43,30,21,.82); line-height:1.45; font-size:12px}

    .footer{
      margin-top:16px;
      color: rgba(43,30,21,.70);
      font-size:12px;
      line-height:1.55;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding:2px 6px;
      border:1px solid rgba(43,30,21,.22);
      border-bottom-width:2px;
      border-radius:8px;
      background: rgba(255,255,255,.35);
    }

    .toast{
      position:fixed;
      left:50%; bottom:18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(43,30,21,.22);
      background: rgba(243,230,200,.95);
      box-shadow: 0 16px 55px rgba(43,30,21,.20);
      color: rgba(43,30,21,.88);
      font-size: 12px;
      display:none;
      z-index:60;
      max-width: min(780px, calc(100vw - 30px));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .toast.on{display:block; animation: pop .18s ease-out}
    @keyframes pop{
      from{transform:translateX(-50%) translateY(8px); opacity:0}
      to{transform:translateX(-50%) translateY(0px); opacity:1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topfrieze" aria-hidden="true"></div>

    <header>
      <section class="hero">
        <div class="kicker">Интерактивный разбор • манёвры • вооружение • озвучка</div>
        <h1>Битва при Кадеше для Сережи</h1>
        <p class="orn">— стиль «папирус, золото и лазурит» —</p>
        <p class="sub">Египтяне Рамсеса II против хеттов Муваталли II у крепости Кадеш на Оронте. Ниже — пять фаз боя, стрелки манёвров, оценочные численности и озвучка (4–5 минут), синхронизированная с тем, что показывается на карте.</p>
        <div class="pillrow">
          <span class="pill"><span class="dot" style="background:rgba(212,175,55,.95)"></span>Египет: ≈20 тыс. (4×≈4–6 тыс.)</span>
          <span class="pill"><span class="dot" style="background:rgba(30,58,138,.9)"></span>Хеттские колесницы: ≈2 500–3 500 (≈8–11 тыс. чел.)</span>
          <span class="pill"><span class="dot" style="background:rgba(15,118,110,.9)"></span>Лагерь и переправа</span>
        </div>
      </section>

      <aside class="side">
        <div class="card">
          <div class="row">
            <button class="primary" id="btnSpeak">▶ Запуск (RU)</button>
            <button id="btnPause" disabled>⏸ Пауза</button>
            <button class="danger" id="btnStop" disabled>■ Стоп</button>
          </div>
          <p class="small" style="margin:10px 0 0">
            Озвучка использует встроенный синтез речи браузера (Web Speech API). Если русских голосов нет — открой в Chrome/Edge или включи русский голос в настройках ОС.
          </p>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
            <div>
              <div style="font-weight:900; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;">Управление</div>
              <div class="small">Кликни фазу или жми <span class="kbd">←</span>/<span class="kbd">→</span></div>
            </div>
            <div style="text-align:right">
              <div class="small">Авто-показ:</div>
              <div class="row" style="justify-content:flex-end">
                <button id="btnAuto">⟳ </button>
              </div>
            </div>
          </div>
          <div class="legend">
            <span class="legendItem"><span class="swatch" style="background: rgba(212,175,55,.35)"></span> Египет</span>
            <span class="legendItem"><span class="swatch" style="background: rgba(30,58,138,.28)"></span> Хетты</span>
            <span class="legendItem"><span class="swatch" style="background: rgba(15,118,110,.22)"></span> Лагерь</span>
          </div>
        </div>
      </aside>
    </header>

    <main>
      <section class="viz" aria-label="Визуализация">
        <div class="vizHead">
          <div>
            <p class="phaseTitle" id="phaseTitle">Фаза 1/5 — Марш к Кадешу и «ложная информация»</p>
            <div class="phaseText" id="phaseText">Египетская армия растягивается по дороге. Хетты прячут ударную группу колесниц у переправы и за холмами, а разведка вводится в заблуждение.</div>
          </div>
          <div class="toggleRow">
            <button id="btnManeuvers" class="primary">↳ Показать манёвры</button>
            <button id="btnReset">↺ Сброс</button>
          </div>
        </div>

        <div class="mapWrap">
          <svg viewBox="0 0 1000 620" role="img" aria-label="Схема поля битвы при Кадеше">
            <defs>
              <linearGradient id="sandGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="rgba(243,230,200,.95)" />
                <stop offset="1" stop-color="rgba(234,216,174,.72)" />
              </linearGradient>
              <linearGradient id="riverGrad" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="rgba(30,58,138,.42)" />
                <stop offset="1" stop-color="rgba(30,58,138,.20)" />
              </linearGradient>
              <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="8" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10 Z" fill="currentColor"></path>
              </marker>

              <!-- “No icons” texture patterns (Egyptian-ish, geometric) -->
              <!-- Chariot-ish: wheels + axle -->
              <pattern id="pChariot" patternUnits="userSpaceOnUse" width="42" height="42">
                <g opacity="0.95">
                  <circle cx="12" cy="14" r="4" fill="none" stroke="rgba(43,30,21,.55)" stroke-width="1.6"/>
                  <circle cx="26" cy="14" r="4" fill="none" stroke="rgba(43,30,21,.55)" stroke-width="1.6"/>
                  <line x1="12" y1="14" x2="26" y2="14" stroke="rgba(43,30,21,.55)" stroke-width="1.6" />
                  <line x1="8" y1="24" x2="30" y2="24" stroke="rgba(43,30,21,.45)" stroke-width="1.2" />
                  <line x1="18" y1="24" x2="18" y2="34" stroke="rgba(43,30,21,.35)" stroke-width="1.2" />
                </g>
              </pattern>

              <!-- Infantry-ish: spears + shields -->
              <pattern id="pInf" patternUnits="userSpaceOnUse" width="28" height="28">
                <g opacity="0.95">
                  <line x1="8" y1="4" x2="8" y2="24" stroke="rgba(43,30,21,.55)" stroke-width="1.4"/>
                  <polygon points="8,4 5.5,8 10.5,8" fill="rgba(43,30,21,.45)"/>
                  <line x1="18" y1="6" x2="18" y2="26" stroke="rgba(43,30,21,.45)" stroke-width="1.2"/>
                  <polygon points="18,6 16,9 20,9" fill="rgba(43,30,21,.35)"/>
                  <circle cx="22" cy="14" r="3.4" fill="none" stroke="rgba(43,30,21,.45)" stroke-width="1.2"/>
                </g>
              </pattern>

              <!-- Camp-ish: tents/triangles -->
              <pattern id="pCamp" patternUnits="userSpaceOnUse" width="56" height="56">
                <g opacity="0.9">
                  <polygon points="16,40 28,16 40,40" fill="none" stroke="rgba(43,30,21,.45)" stroke-width="1.4"/>
                  <line x1="28" y1="16" x2="28" y2="40" stroke="rgba(43,30,21,.35)" stroke-width="1.2"/>
                  <polygon points="10,44 18,30 26,44" fill="none" stroke="rgba(43,30,21,.35)" stroke-width="1.2"/>
                </g>
              </pattern>

              <!-- Reserve: mix (spear + wheel) -->
              <pattern id="pReserve" patternUnits="userSpaceOnUse" width="44" height="44">
                <g opacity="0.95">
                  <circle cx="14" cy="14" r="4" fill="none" stroke="rgba(43,30,21,.48)" stroke-width="1.4"/>
                  <circle cx="26" cy="14" r="4" fill="none" stroke="rgba(43,30,21,.48)" stroke-width="1.4"/>
                  <line x1="14" y1="14" x2="26" y2="14" stroke="rgba(43,30,21,.48)" stroke-width="1.4"/>
                  <line x1="34" y1="8" x2="34" y2="34" stroke="rgba(43,30,21,.45)" stroke-width="1.2"/>
                  <polygon points="34,8 31.7,11.8 36.3,11.8" fill="rgba(43,30,21,.35)"/>
                </g>
              </pattern>
            </defs>

            <!-- Terrain -->
            <g class="terrain">
              <!-- decorative border -->
              <rect x="10" y="10" width="980" height="600" rx="20" fill="none" stroke="rgba(43,30,21,.30)" stroke-width="4"/>
              <rect x="16" y="16" width="968" height="588" rx="18" fill="url(#sandGrad)" stroke="rgba(212,175,55,.45)" stroke-width="2"/>

              <!-- hills -->
              <path d="M130 160 C 220 110, 290 120, 350 165 C 410 210, 460 205, 520 175 C 610 130, 705 150, 760 210 C 810 260, 855 265, 920 230 L920 320 L130 320 Z" fill="rgba(43,30,21,.08)" />
              <path d="M80 420 C 150 380, 240 390, 300 440 C 360 490, 420 500, 500 460 C 580 420, 650 420, 740 470 C 810 510, 900 510, 940 470 L940 590 L80 590 Z" fill="rgba(43,30,21,.06)" />

              <!-- river -->
              <path d="M680 60 C 600 150, 700 240, 650 320 C 600 420, 700 480, 640 560"
                    stroke="rgba(30,58,138,.26)" stroke-width="28" stroke-linecap="round" fill="none" opacity=".9" />
              <path d="M680 60 C 600 150, 700 240, 650 320 C 600 420, 700 480, 640 560"
                    stroke="url(#riverGrad)" stroke-width="18" stroke-linecap="round" fill="none" opacity=".95" />

              <!-- Kadesh -->
              <g>
                <ellipse cx="705" cy="165" rx="62" ry="36" fill="rgba(43,30,21,.10)" />
                <path d="M660 165 Q705 110 750 165 Q705 215 660 165Z" fill="rgba(255,255,255,.25)" stroke="rgba(43,30,21,.22)" />
                <text x="705" y="172" text-anchor="middle" class="poi">КАДЕШ</text>
                <text x="705" y="192" text-anchor="middle" class="poiSmall">крепость у Оронта</text>
              </g>

              <!-- crossing -->
              <g>
                <circle cx="650" cy="315" r="8" fill="rgba(212,175,55,.55)" opacity=".75" />
                <text x="665" y="320" class="poiSmall">Брод / переправа</text>
              </g>

              <!-- road -->
              <path d="M60 120 C 260 140, 420 200, 520 280 C 580 330, 610 380, 640 440"
                    stroke="rgba(43,30,21,.22)" stroke-width="6" fill="none" stroke-linecap="round" opacity=".55" />
              <path d="M60 120 C 260 140, 420 200, 520 280 C 580 330, 610 380, 640 440"
                    stroke="rgba(212,175,55,.30)" stroke-width="2" fill="none" stroke-linecap="round" opacity=".8" />
              <text x="95" y="105" class="poiSmall">дорога египтян</text>
            </g>

            <!-- arrows -->
            <g id="arrows">
              <path id="a1" class="arrow hit" marker-end="url(#arrowHead)" style="color: rgba(30,58,138,.88)" d="M 610 255 C 550 255, 500 260, 430 280" />
              <path id="a2" class="arrow hit bad" marker-end="url(#arrowHead)" style="color: rgba(155,44,26,.88)" d="M 610 300 C 560 320, 520 340, 470 360" />
              <path id="a3" class="arrow egy" marker-end="url(#arrowHead)" style="color: rgba(212,175,55,.92)" d="M 360 330 C 410 300, 460 285, 510 280" />
              <path id="a4" class="arrow egy" marker-end="url(#arrowHead)" style="color: rgba(212,175,55,.92)" d="M 480 420 C 520 400, 560 380, 600 355" />
              <path id="a5" class="arrow hit" marker-end="url(#arrowHead)" style="color: rgba(30,58,138,.88)" d="M 520 420 C 565 430, 610 445, 650 470" />
            </g>

            <!-- Units (no icons, only textured fill + labels) -->
            <g id="units">
              <!-- Egypt divisions (chariot-ish texture, because they are combined arms) -->
              <g id="uAmun" class="unit egy" style="--x:260px; --y:260px" tabindex="0" role="button" aria-label="Египет: дивизия Амон">
                <rect class="base" x="0" y="0" width="190" height="78" />
                <rect class="patFill" x="0" y="0" width="190" height="78" rx="12" fill="url(#pChariot)"/>
                <text x="14" y="24">Амон</text>
                <text x="14" y="45" class="tag">колесницы + пехота</text>
                <text x="14" y="66" class="count">≈4–6 тыс. (≈500 колесниц)</text>
              </g>

              <g id="uRa" class="unit egy" style="--x:120px; --y:155px" tabindex="0" role="button" aria-label="Египет: дивизия Ра">
                <rect class="base" x="0" y="0" width="190" height="78" />
                <rect class="patFill" x="0" y="0" width="190" height="78" rx="12" fill="url(#pChariot)"/>
                <text x="14" y="24">Ра</text>
                <text x="14" y="45" class="tag">в колонне на марше</text>
                <text x="14" y="66" class="count">≈4–6 тыс. (≈500 колесниц)</text>
              </g>

              <g id="uPtah" class="unit egy" style="--x:40px; --y:70px" tabindex="0" role="button" aria-label="Египет: дивизия Птах">
                <rect class="base" x="0" y="0" width="190" height="78" />
                <rect class="patFill" x="0" y="0" width="190" height="78" rx="12" fill="url(#pChariot)"/>
                <text x="14" y="24">Птах</text>
                <text x="14" y="45" class="tag">далеко позади</text>
                <text x="14" y="66" class="count">≈4–6 тыс. (≈500 колесниц)</text>
              </g>

              <g id="uSeth" class="unit egy" style="--x:40px; --y:510px" tabindex="0" role="button" aria-label="Египет: дивизия Сет">
                <rect class="base" x="0" y="0" width="190" height="78" />
                <rect class="patFill" x="0" y="0" width="190" height="78" rx="12" fill="url(#pChariot)"/>
                <text x="14" y="24">Сет</text>
                <text x="14" y="45" class="tag">арьергард</text>
                <text x="14" y="66" class="count">≈4–6 тыс. (≈500 колесниц)</text>
              </g>

              <!-- Camp -->
              <g id="uCamp" class="unit camp" style="--x:420px; --y:380px" tabindex="0" role="button" aria-label="Египетский лагерь">
                <rect class="base" x="0" y="0" width="240" height="86" />
                <rect class="patFill" x="0" y="0" width="240" height="86" rx="12" fill="url(#pCamp)"/>
                <text x="14" y="30">Лагерь Рамсеса</text>
                <text x="14" y="54" class="tag">периметр щитов/телег</text>
                <text x="14" y="76" class="count">внутри в кризис: ≈6–10 тыс.</text>
              </g>

              <!-- Hittite chariots -->
              <g id="uHCh" class="unit hit" style="--x:560px; --y:220px" tabindex="0" role="button" aria-label="Хетты: ударные колесницы">
                <rect class="base" x="0" y="0" width="255" height="78" />
                <rect class="patFill" x="0" y="0" width="255" height="78" rx="12" fill="url(#pChariot)"/>
                <text x="14" y="24">Колесницы хеттов</text>
                <text x="14" y="45" class="tag">тяжёлые • экипаж 3</text>
                <text x="14" y="66" class="count">≈8–11 тыс. (≈2 500–3 500)</text>
              </g>

              <!-- Hittite infantry -->
              <g id="uHInf" class="unit hit" style="--x:760px; --y:250px" tabindex="0" role="button" aria-label="Хетты: пехота у Кадеша">
                <rect class="base" x="0" y="0" width="235" height="78" />
                <rect class="patFill" x="0" y="0" width="235" height="78" rx="12" fill="url(#pInf)"/>
                <text x="14" y="24">Пехота хеттов</text>
                <text x="14" y="45" class="tag">копья • щиты • союзники</text>
                <text x="14" y="66" class="count">≈15–40 тыс. (оценочно)</text>
              </g>

              <!-- Reserve -->
              <g id="uReserve" class="unit hit" style="--x:730px; --y:420px" tabindex="0" role="button" aria-label="Хетты: резервы у реки">
                <rect class="base" x="0" y="0" width="235" height="78" />
                <rect class="patFill" x="0" y="0" width="235" height="78" rx="12" fill="url(#pReserve)"/>
                <text x="14" y="24">Резерв / лагерь</text>
                <text x="14" y="45" class="tag">у брода • контроль тыла</text>
                <text x="14" y="66" class="count">≈5–15 тыс. (условно)</text>
              </g>
            </g>
          </svg>
        </div>

        <div class="timeline">
          <div class="dots" id="dots"></div>
          <div class="hint">Клик по отряду → детали | Озвучка переключает фазы</div>
        </div>
      </section>

      <aside class="sidebar" aria-label="Панель деталей">
        <div class="tabs">
          <div class="tab active" data-tab="story">Сюжет</div>
          <div class="tab" data-tab="weapons">Вооружение</div>
          <div class="tab" data-tab="tactics">Манёвры</div>
        </div>

        <div class="pane active" id="pane-story">
          <div class="fact">
            <div class="dot" style="background:rgba(212,175,55,.95); margin-top:3px"></div>
            <div>
              <b>Египетская колонна</b>
              <p>Дивизии идут с разрывами. Это удобно на марше, но опасно: по одной части можно ударить, пока другие далеко.</p>
            </div>
          </div>
          <div class="fact">
            <div class="dot" style="background:rgba(30,58,138,.9); margin-top:3px"></div>
            <div>
              <b>Замысел хеттов</b>
              <p>Внезапный удар колесниц по дивизии Ра на марше, затем попытка прорваться в лагерь до подхода Птаха и Сета.</p>
            </div>
          </div>
          <div class="fact">
            <div class="dot" style="background:rgba(15,118,110,.9); margin-top:3px"></div>
            <div>
              <b>Лагерь как «крепость»</b>
              <p>Периметр телег, щитов и копий — точка, из которой удобно запускать контратаки колесниц и собирать войска.</p>
            </div>
          </div>
          <p class="small">Иконки убраны: теперь различие типов войск передаётся узором внутри блока.</p>
        </div>

        <div class="pane" id="pane-weapons">
          <div class="grid2">
            <div class="wcard" data-modal="egypt-chariot">
              <div class="whead"><h3>Египетская колесница</h3><span class="badge">лёгкая • 2 человека</span></div>
              <div class="wbody"><p>Скорость, разворот, залпы из лука на ходу. Стиль «бей-и-уходи».</p></div>
            </div>

            <div class="wcard" data-modal="hittite-chariot">
              <div class="whead"><h3>Хеттская колесница</h3><span class="badge">тяжелее • 3 человека</span></div>
              <div class="wbody"><p>Сильна в первом ударе и прорыве по колонне: экипаж часто трое.</p></div>
            </div>

            <div class="wcard" data-modal="egypt-infantry">
              <div class="whead"><h3>Египетская пехота</h3><span class="badge">луки • копья • хопеш</span></div>
              <div class="wbody"><p>Держит лагерь и проходы, прикрывает колесницы, добивает в ближнем бою.</p></div>
            </div>

            <div class="wcard" data-modal="hittite-infantry">
              <div class="whead"><h3>Хеттская пехота</h3><span class="badge">копья • щиты • союзники</span></div>
              <div class="wbody"><p>Закрепляет успех колесниц и удерживает район Кадеша/переправы.</p></div>
            </div>
          </div>
          <p class="small" style="margin-top:10px">Кликни карточку — откроется окно с деталями.</p>
        </div>

        <div class="pane" id="pane-tactics">
          <div class="fact">
            <div class="dot" style="background:rgba(155,44,26,.85); margin-top:3px"></div>
            <div>
              <b>Ключевой удар хеттов</b>
              <p>Засада колесниц по дивизии Ра на марше: ломает строй и открывает путь к лагерю.</p>
            </div>
          </div>
          <div class="fact">
            <div class="dot" style="background:rgba(212,175,55,.85); margin-top:3px"></div>
            <div>
              <b>Ответ египтян</b>
              <p>Лагерь как опора + серия контратак колесниц дугой с обстрелом и отходом.</p>
            </div>
          </div>
          <div class="fact">
            <div class="dot" style="background:rgba(30,58,138,.80); margin-top:3px"></div>
            <div>
              <b>Поворот</b>
              <p>Подход подкреплений и Птаха: хеттские группы теряют темп и отходят к реке.</p>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <div class="footer">
      <b>Заметка:</b> точные числа спорны (источники во многом египетские царские тексты). Здесь показаны учебные манёвры и оценочные диапазоны.
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-label="Детали">
    <div class="modalCard">
      <div class="modalTop">
        <h2 id="modalTitle">Детали</h2>
        <button class="x" id="modalClose">✕</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ----------------------
    // Phases
    // ----------------------
    const phases = [
      {
        title: "Фаза 1/5 — Марш к Кадешу и «ложная информация»",
        text: "Египетская армия растягивается по дороге. Хетты прячут ударную группу колесниц у переправы и за холмами, а разведка вводится в заблуждение.",
        positions: { uAmun:[260,260], uRa:[120,155], uPtah:[40,70], uSeth:[40,510], uCamp:[420,380], uHCh:[560,220], uHInf:[760,250], uReserve:[730,420] },
        arrows: []
      },
      {
        title: "Фаза 2/5 — Засада: удар по дивизии Ра в движении",
        text: "Хеттские колесницы внезапно выходят из укрытия и бьют по дивизии Ра на марше. В колонне возникает хаос, часть войск откатывается к лагерю.",
        positions: { uAmun:[300,285], uRa:[260,215], uPtah:[80,95], uSeth:[40,510], uCamp:[420,380], uHCh:[520,250], uHInf:[770,250], uReserve:[710,420] },
        arrows: ["a1","a2"]
      },
      {
        title: "Фаза 3/5 — Прорыв к лагерю и кризис",
        text: "Часть хеттских колесниц вкатывается к лагерю. Рамсес опирается на Амона и организует оборону. Лагерь становится опорным пунктом для контратаки.",
        positions: { uAmun:[340,305], uRa:[315,250], uPtah:[110,120], uSeth:[60,505], uCamp:[420,370], uHCh:[470,330], uHInf:[780,250], uReserve:[710,420] },
        arrows: ["a2","a3"]
      },
      {
        title: "Фаза 4/5 — Контратака египтян и подход подкреплений",
        text: "Египетские колесницы бьют по разрозненным группам хеттов у лагеря и к переправе. Подходят подкрепления и затем Птах — давление на хеттов растёт.",
        positions: { uAmun:[360,315], uRa:[330,270], uPtah:[190,180], uSeth:[90,500], uCamp:[420,370], uHCh:[520,350], uHInf:[790,260], uReserve:[690,430] },
        arrows: ["a3","a4"]
      },
      {
        title: "Фаза 5/5 — Отход хеттов и итог",
        text: "Колесницы хеттов отходят к реке и резервам; обе стороны истощены. Итог — скорее ничья: лагерь удержан, но Кадеш не взят.",
        positions: { uAmun:[360,305], uRa:[320,265], uPtah:[240,230], uSeth:[120,495], uCamp:[420,370], uHCh:[610,430], uHInf:[770,250], uReserve:[710,430] },
        arrows: ["a5"]
      }
    ];

    const unitIds = ["uAmun","uRa","uPtah","uSeth","uCamp","uHCh","uHInf","uReserve"];
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const phaseTitle = $("#phaseTitle");
    const phaseText = $("#phaseText");
    const dots = $("#dots");

    let phase = 0;
    let showManeuvers = false;
    let autoTimer = null;

    function setUnitPos(id, x, y){
      const el = document.getElementById(id);
      if(!el) return;
      el.style.setProperty('--x', `${x}px`);
      el.style.setProperty('--y', `${y}px`);
    }

    function setArrows(ids){
      const all = ["a1","a2","a3","a4","a5"];
      for(const a of all){
        const el = document.getElementById(a);
        if(el) el.classList.remove('on');
      }
      if(!showManeuvers) return;
      for(const id of ids){
        const el = document.getElementById(id);
        if(el) el.classList.add('on');
      }
    }

    function updateDots(){
      $$('.tdot', dots).forEach((d, i)=>{
        d.classList.toggle('active', i===phase);
        d.title = phases[i].title;
      });
    }

    function applyPhase(i, {quiet=false}={}){
      phase = (i + phases.length) % phases.length;
      const p = phases[phase];
      phaseTitle.textContent = p.title;
      phaseText.textContent = p.text;

      for(const id of unitIds){
        const [x,y] = p.positions[id];
        setUnitPos(id,x,y);
      }

      setArrows(p.arrows);
      updateDots();
      if(!quiet) toastMsg(`Переключено: ${p.title}`);
    }

    function buildDots(){
      dots.innerHTML = '';
      phases.forEach((p,i)=>{
        const d = document.createElement('div');
        d.className = 'tdot' + (i===0?' active':'');
        d.addEventListener('click', ()=> applyPhase(i));
        dots.appendChild(d);
      });
    }

    // Tabs
    $$('.tab').forEach(t=>{
      t.addEventListener('click', ()=>{
        $$('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const key = t.dataset.tab;
        $$('.pane').forEach(p=>p.classList.remove('active'));
        $('#pane-' + key).classList.add('active');
      });
    });

    // Maneuvers toggle
    const btnManeuvers = $('#btnManeuvers');
    btnManeuvers.addEventListener('click', ()=>{
      showManeuvers = !showManeuvers;
      btnManeuvers.textContent = showManeuvers ? '↳ Скрыть манёвры' : '↳ Показать манёвры';
      btnManeuvers.classList.toggle('primary', !showManeuvers);
      setArrows(phases[phase].arrows);
      toastMsg(showManeuvers ? 'Манёвры включены' : 'Манёвры выключены');
    });

    // Reset
    $('#btnReset').addEventListener('click', ()=>{
      stopAuto();
      stopSpeech(true);
      showManeuvers = false;
      btnManeuvers.textContent = '↳ Показать манёвры';
      btnManeuvers.classList.add('primary');
      applyPhase(0, {quiet:true});
      setArrows([]);
      updateDots();
      toastMsg('Сброшено к фазе 1');
    });

    // Auto
    const btnAuto = $('#btnAuto');
    function startAuto(){
      stopAuto();
      btnAuto.textContent = '⏸ Остановить';
      autoTimer = setInterval(()=> applyPhase(phase+1, {quiet:true}), 3700);
      toastMsg('Авто-показ запущен');
    }
    function stopAuto(){
      if(autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
      }
      btnAuto.textContent = '⟳ ';
    }
    btnAuto.addEventListener('click', ()=> autoTimer ? stopAuto() : startAuto());

    // Keyboard
    window.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowRight') applyPhase(phase+1);
      if(e.key === 'ArrowLeft') applyPhase(phase-1);
      if(e.key === 'Escape') closeModal();
    });

    // Toast
    const toast = $('#toast');
    let toastT = null;
    function toastMsg(msg){
      toast.textContent = msg;
      toast.classList.add('on');
      clearTimeout(toastT);
      toastT = setTimeout(()=> toast.classList.remove('on'), 1200);
    }

    // ----------------------
    // Modal data
    // ----------------------
    const modal = $('#modal');
    const modalTitle = $('#modalTitle');
    const modalBody = $('#modalBody');

    const modalData = {
      "egypt-chariot": {
        title: "Египетская колесница (лёгкая, 2 человека)",
        body: `
          <p><b>Роль:</b> быстрые заходы дугой, залпы из составного лука на скорости. Удобна для серии ударов “бей-и-уходи”.</p>
          <div class="cols">
            <div class="mini"><h4>Экипаж</h4><ul><li>возничий</li><li>лучник</li></ul></div>
            <div class="mini"><h4>Вооружение</h4><ul><li>составной лук</li><li>дротики/копьё</li><li>меч (в т.ч. хопеш)</li></ul></div>
          </div>`
      },
      "hittite-chariot": {
        title: "Хеттская колесница (тяжелее, 3 человека)",
        body: `
          <p><b>Роль:</b> прорыв и давление массой, особенно против колонны на марше. Часто трое в экипаже.</p>
          <div class="cols">
            <div class="mini"><h4>Экипаж</h4><ul><li>возничий</li><li>лучник</li><li>щитоносец/копейщик</li></ul></div>
            <div class="mini"><h4>Особенность</h4><ul><li>устойчивее в “толче”</li><li>опасна в первом ударе</li></ul></div>
          </div>`
      },
      "egypt-infantry": {
        title: "Египетская пехота",
        body: `<p><b>Роль:</b> удержание лагеря и проходов, поддержка колесниц, ближний бой (копья, мечи, топоры) и стрельба.</p>`
      },
      "hittite-infantry": {
        title: "Хеттская пехота",
        body: `<p><b>Роль:</b> закрепление успеха колесниц и контроль района Кадеша/переправ. Копья, щиты, контингенты союзников.</p>`
      },
      "unit-amun": { title:"Дивизия Амона", body:`<p>Оказалась рядом с Рамсесом в момент удара. Даёт ядро обороны и контратак от лагеря.</p>` },
      "unit-ra":   { title:"Дивизия Ра",   body:`<p>Уязвима в движении: именно по ней бьёт засада колесниц, ломая колонну.</p>` },
      "unit-ptah": { title:"Дивизия Птаха",body:`<p>Подходит позже и усиливает давление: хеттам сложнее удержаться между лагерем и рекой.</p>` },
      "unit-seth": { title:"Дивизия Сета", body:`<p>Дальняя часть колонны. Разрывы между дивизиями — ключ к замыслу хеттов.</p>` },
      "unit-camp": { title:"Лагерь Рамсеса", body:`<p>Опорный пункт: периметр телег/щитов, место сбора и стартовая площадка контратак.</p>` },
      "unit-hch":  { title:"Колесницы хеттов", body:`<p>Главный удар по колонне + попытка прорыва в лагерь до подхода египетских резервов.</p>` },
      "unit-hinf": { title:"Пехота хеттов", body:`<p>Удержание района Кадеша и поддержка колесниц, особенно в затяжном бою.</p>` },
      "unit-res":  { title:"Резервы хеттов", body:`<p>Контроль переправы и подстраховка тыла — ключ, если бой затягивается у реки.</p>` },
    };

    function openModal(key){
      const data = modalData[key];
      if(!data) return;
      modalTitle.textContent = data.title;
      modalBody.innerHTML = data.body;
      modal.classList.add('on');
    }
    function closeModal(){ modal.classList.remove('on'); }
    $('#modalClose').addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

    // weapon cards
    $$('.wcard').forEach(c=> c.addEventListener('click', ()=> openModal(c.dataset.modal)));

    // unit click opens relevant modal
    const unitToModal = { uAmun:'unit-amun', uRa:'unit-ra', uPtah:'unit-ptah', uSeth:'unit-seth', uCamp:'unit-camp', uHCh:'unit-hch', uHInf:'unit-hinf', uReserve:'unit-res' };
    unitIds.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', ()=> openModal(unitToModal[id]));
      el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') openModal(unitToModal[id]); });
    });

    // ----------------------
    // Narration (RU) — synced
    // ----------------------
    const narrationSegments = [
      {
        phase: 0,
        text:
`Представь жаркий день у реки Оронт. Перед нами крепость Кадеш — узел дорог, за который спорят Египет Рамсеса Второго и Хеттское царство Муваталли Второго.

Египетская армия идёт колонной, разделённой на дивизии: Амон, Ра, Птах и Сет. В каждой — оценочно по четыре–шесть тысяч человек и примерно несколько сотен колесниц. Такой порядок удобен на марше, но опасен: между дивизиями есть разрывы, и удар по одной части может застать остальные далеко.

Хетты делают ставку на обман и внезапность. Их ударный кулак колесниц скрыт у переправы и за холмами, чтобы вырваться в нужный момент. Рамсес оказывается впереди с Амоном и начинает разбивать лагерь — не ожидая, что главная опасность уже рядом.`
      },
      {
        phase: 1,
        text:
`Начинается ключевой манёвр хеттов: засада по дивизии Ра в движении. Пока Ра идёт по дороге и ещё не успела построиться, из укрытия вырывается масса хеттских колесниц.

Оценочно это две с половиной — три с половиной тысячи колесниц. В экипажах — восемь–одиннадцать тысяч человек, потому что хеттская колесница часто несёт троих: возничего, лучника и щитоносца или копейщика. Удар по движущейся колонне ломает строй: телеги, пехота и колесницы смешиваются, команды теряются, появляется паника.

Задача хеттов — не просто нанести потери, а “свернуть” всю армию, пока Птах и Сет ещё далеко позади.`
      },
      {
        phase: 2,
        text:
`Часть хеттских колесниц развивает успех и пытается ворваться в египетский лагерь. Это самый опасный момент: лагерь ещё формируется, но египтяне быстро делают из него опорный пункт — периметр телег, щитов и копий.

Внутри лагеря в кризис может оказаться порядка шести–десяти тысяч человек: дивизия Амона плюс те, кто успел добежать от Ра. Рамсес опирается на лагерь как на точку сборки и начинает контратаку.

Египетская колесница обычно легче и манёвреннее: экипаж двое — возничий и лучник. Сильная сторона — скорость и залповая стрельба из лука на ходу. Египтяне делают серию заходов дугой: удар — обстрел — отход — снова сбор у лагеря.`
      },
      {
        phase: 3,
        text:
`Постепенно у хеттов появляются трудности. Их колесницы у лагеря рассеиваются: часть увлекается преследованием и добычей, часть упирается в препятствия местности и в то, что рядом река. Массовый удар, страшный в первую минуту, превращается в набор отдельных групп.

В этот момент подходят подкрепления, а затем подтягивается и дивизия Птаха — ещё несколько тысяч свежих людей. Египетские колесницы продолжают бить по разрозненным группам, а пехота удерживает периметр и проходы.

Хеттам становится рискованно оставаться между лагерем и рекой: если задержаться, можно потерять связь с переправой и резервами.`
      },
      {
        phase: 4,
        text:
`К концу дня бой выдыхается. Хеттские колесницы отходят к реке и резервам; их пехота остаётся в районе Кадеша. Египтяне удерживают лагерь, но крепость не берут. Итог получается двусмысленным: обе стороны объявляют о победе, но по сути это скорее ничья.

Зато Кадеш — важный урок тактики. Хетты показали силу внезапного удара колесниц по растянутой колонне. Египтяне показали обратное: как опорный пункт и управляемая серия контратак способны вернуть инициативу после тяжёлого удара.

Если хочешь — включай манёвры и снова проходи фазы: ты буквально увидишь, как меняется темп боя от засады к кризису у лагеря, а затем к контратакам и отходу.`
      }
    ];

    const btnSpeak = $('#btnSpeak');
    const btnPause = $('#btnPause');
    const btnStop = $('#btnStop');

    let speechQueue = [];
    let speechIndex = 0;
    let speaking = false;
    let paused = false;
    let chosenVoice = null;

    function pickRussianVoice(){
      const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      const ru = voices.filter(v => (v.lang || '').toLowerCase().startsWith('ru'));
      const preferredNames = ['Google', 'Microsoft', 'Yandex', 'Sber'];
      for(const name of preferredNames){
        const found = ru.find(v => (v.name || '').includes(name));
        if(found) return found;
      }
      return ru[0] || null;
    }

    function buildSpeechQueue(){
      speechQueue = narrationSegments.map(seg => {
        const u = new SpeechSynthesisUtterance(seg.text);
        u.lang = 'ru-RU';
        u.rate = 1.02;
        u.pitch = 1;
        u.volume = 1;
        if(chosenVoice) u.voice = chosenVoice;

        u.onstart = () => {
          applyPhase(seg.phase, {quiet:true});
          showManeuvers = true;
          btnManeuvers.textContent = '↳ Скрыть манёвры';
          btnManeuvers.classList.remove('primary');
          setArrows(phases[phase].arrows);
        };

        u.onend = () => {
          if(!speaking) return;
          speechIndex++;
          if(speechIndex < speechQueue.length){
            speechSynthesis.speak(speechQueue[speechIndex]);
          }else{
            speaking = false;
            paused = false;
            btnSpeak.disabled = false;
            btnPause.disabled = true;
            btnStop.disabled = true;
            btnPause.textContent = '⏸ Пауза';
            toastMsg('Озвучка завершена');
          }
        };

        u.onerror = () => {
          speaking = false;
          paused = false;
          btnSpeak.disabled = false;
          btnPause.disabled = true;
          btnStop.disabled = true;
          toastMsg('Не удалось озвучить: проверь доступные голоса');
        };

        return u;
      });
      speechIndex = 0;
    }

    function startSpeech(){
      if(!('speechSynthesis' in window)){
        toastMsg('Синтез речи не поддерживается');
        return;
      }
      stopAuto();
      stopSpeech(true);

      chosenVoice = pickRussianVoice();
      buildSpeechQueue();

      speaking = true;
      paused = false;
      btnSpeak.disabled = true;
      btnPause.disabled = false;
      btnStop.disabled = false;
      btnPause.textContent = '⏸ Пауза';

      speechSynthesis.speak(speechQueue[0]);
      toastMsg(chosenVoice ? `Озвучка: ${chosenVoice.name}` : 'Озвучка запущена');
    }

    function togglePause(){
      if(!speaking) return;
      if(!paused){
        speechSynthesis.pause();
        paused = true;
        btnPause.textContent = '▶ Продолжить';
        toastMsg('Пауза');
      }else{
        speechSynthesis.resume();
        paused = false;
        btnPause.textContent = '⏸ Пауза';
        toastMsg('Продолжаю');
      }
    }

    function stopSpeech(quiet=false){
      if(!('speechSynthesis' in window)) return;
      speechSynthesis.cancel();
      speaking = false;
      paused = false;
      btnSpeak.disabled = false;
      btnPause.disabled = true;
      btnStop.disabled = true;
      btnPause.textContent = '⏸ Пауза';
      if(!quiet) toastMsg('Озвучка остановлена');
    }

    btnSpeak.addEventListener('click', startSpeech);
    btnPause.addEventListener('click', togglePause);
    btnStop.addEventListener('click', () => stopSpeech(false));

    // Init
    buildDots();
    applyPhase(0, {quiet:true});
  </script>
</body>
</html>
